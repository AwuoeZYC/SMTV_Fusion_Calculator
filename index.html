<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMTV:R - 最优价格合成器 v2.3.2 (展开修复)</title>
    <style>
        :root {
            --bg-color: #1a1a2e; --primary-color: #16213e; --secondary-color: #0f3460;
            --accent-color: #e94560; --text-color: #dcdcdc; --border-color: #535353;
            --success-color: #4CAF50; --danger-color: #f44336; --link-color: #87CEEB;
            --edit-color: #ff9800;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 15px; font-size: 16px;
        }
        .container { max-width: 900px; margin: 0 auto; padding: 20px; background-color: var(--primary-color); border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .tabs { display: flex; border-bottom: 2px solid var(--secondary-color); margin-bottom: 20px; }
        .tab-button { padding: 10px 20px; cursor: pointer; background-color: transparent; border: none; color: var(--text-color); font-size: 1.1em; opacity: 0.7; transition: all 0.3s; border-bottom: 3px solid transparent; }
        .tab-button.active { opacity: 1; border-bottom: 3px solid var(--accent-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        h1, h2, h3 { color: var(--accent-color); border-bottom: 1px solid var(--secondary-color); padding-bottom: 10px; }
        h1 { text-align: center; margin-bottom: 20px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; }
        input[type="text"], input[type="number"], select { width: 100%; padding: 12px; background-color: var(--bg-color); border: 1px solid var(--border-color); color: var(--text-color); border-radius: 5px; box-sizing: border-box; font-size: 1em; }
        button { padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; font-weight: bold; transition: background-color 0.3s; }
        .btn-add { background-color: var(--success-color); color: white; width: 100%; }
        .btn-edit-action { background-color: var(--edit-color); color: white; width: 100%; }
        .btn-delete { background-color: var(--danger-color); color: white; padding: 5px 10px; font-size: 0.8em; }
        .btn-edit { background-color: var(--edit-color); color: white; padding: 5px 10px; font-size: 0.8em; margin-left: auto; }
        .data-list ul { list-style: none; padding: 0; }
        .data-list li { background-color: var(--secondary-color); padding: 10px 15px; margin-bottom: 8px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; gap: 10px;}
        hr { border: 1px solid var(--secondary-color); margin: 25px 0; }
        .form-actions { display: flex; gap: 10px; }
        .calculator-slots { display: flex; align-items: center; justify-content: space-between; gap: 10px; margin-bottom: 20px; }
        .slot { flex: 1; }
        .slot-op { font-size: 2em; font-weight: bold; }
        #results-container { margin-top: 20px; }
        .result-list { list-style: none; padding: 0; }
        .result-item { background: var(--secondary-color); margin-bottom: 10px; padding: 15px; border-radius: 5px; border-left: 4px solid var(--success-color); }
        .result-item.direct-purchase { border-left-color: var(--accent-color); }
        .result-item .demon-link { color: var(--link-color); cursor: pointer; text-decoration: underline; font-weight: bold; }
        .result-item .demon-link:hover { color: var(--accent-color); }
        .result-item .demon-no-link { color: var(--text-color); cursor: default; font-weight: bold; }
        .result-path { font-size: 1.1em; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;}
        .result-cost { font-weight: bold; color: var(--accent-color); margin-left: auto; font-size: 1.2em; text-align: right; }
        .result-cost .breakdown { font-size: 0.6em; font-weight: normal; opacity: 0.8; display: block; }
        .sub-list-container { margin-left: 20px; border-left: 2px solid var(--border-color); padding-left: 15px; margin-top: 10px; }
        .sync-buttons { display: flex; gap: 15px; }
        #cancel-edit-btn { display: none; background-color: grey; color: white; }
    </style>
</head>
<body>

<div class="container">
    <h1>SMTV:R 最优价格合成器 v2.3.2</h1>
    <div class="tabs">
        <button class="tab-button active" onclick="showTab('calculator')">三槽计算器</button>
        <button class="tab-button" onclick="showTab('management')">数据管理</button>
    </div>
    <div id="calculator" class="tab-content active">
        <h2>合成计算器 (真实成本递归)</h2>
        <div class="calculator-slots">
            <div class="slot"><select id="slot1"></select></div><div class="slot-op">+</div>
            <div class="slot"><select id="slot2"></select></div><div class="slot-op">=</div>
            <div class="slot"><select id="slot3"></select></div>
        </div>
        <button onclick="resetCalculator()">重置计算器</button>
        <div id="results-container"></div>
    </div>
    <div id="management" class="tab-content">
        <h2>数据同步</h2>
        <div class="sync-buttons">
            <button onclick="exportData()" class="btn-add">导出数据到文件</button>
            <button onclick="document.getElementById('import-file').click()" style="background-color: var(--accent-color); color: white;">从文件导入数据</button>
            <input type="file" id="import-file" style="display: none;" accept=".json">
        </div>
        <hr>
        <h2 id="demon-form-title">仲魔管理</h2>
        <div class="form-group"><label for="demon-name">仲魔名称：</label><input type="text" id="demon-name"></div>
        <div class="form-group"><label for="demon-level">等级 (Level)：</label><input type="number" id="demon-level"></div>
        <div class="form-group"><label for="demon-price">全书价格 (Macca)：</label><input type="number" id="demon-price"></div>
        <div class="form-actions">
            <button id="demon-submit-btn" class="btn-add" onclick="processDemonForm()">添加仲魔</button>
            <button id="cancel-edit-btn" onclick="cancelEditMode()">取消修改</button>
        </div>
        <hr><h3>已录入的仲魔</h3><div class="data-list" id="demon-list"></div>
        <hr>
        <h2 id="fusion-form-title">合成公式管理</h2>
        <div class="form-group"><label for="source-a-select">素材 1：</label><select id="source-a-select"></select></div>
        <div class="form-group"><label for="source-b-select">素材 2：</label><select id="source-b-select"></select></div>
        <div class="form-group"><label for="result-select">结果：</label><select id="result-select"></select></div>
        <div class="form-actions"><button id="fusion-submit-btn" class="btn-add" onclick="processFusionForm()">添加合成公式</button></div>
        <hr><h3>已录入的公式</h3><div class="data-list" id="fusion-list"></div>
    </div>
</div>

<script>
let db = { demons: [], fusions: [], nextDemonId: 1 };
let editState = { type: 'none', targetId: null };
let costCache = {};

function initializeDefaultData() {
    if (!localStorage.getItem('smtvFusionDB_v2_3_2')) {
        const defaultDB = {
            demons: [
                { id: 1, name: "软泥怪", level: 1, price: 436 }, { id: 2, name: "饿鬼", level: 4, price: 894 },
                { id: 3, name: "猪豚蛇", level: 8, price: 1839 }, { id: 4, name: "背背鬼", level: 5, price: 1200 },
                { id: 5, name: "皮克希", level: 2, price: 560 }, { id: 6, name: "飞天", level: 13, price: 1820},
                { id: 7, name: "天使", level: 14, price: 2100}
            ],
            fusions: [
                { resultId: 3, sourceA_Id: 1, sourceB_Id: 2 }, { resultId: 4, sourceA_Id: 1, sourceB_Id: 3 },
                { resultId: 7, sourceA_Id: 5, sourceB_Id: 6}
            ],
            nextDemonId: 8
        };
        localStorage.setItem('smtvFusionDB_v2_3_2', JSON.stringify(defaultDB));
    }
}
function loadData() {
    const storedDb = localStorage.getItem('smtvFusionDB_v2_3_2');
    db = storedDb ? JSON.parse(storedDb) : { demons: [], fusions: [], nextDemonId: 1 };
}
function saveData() { localStorage.setItem('smtvFusionDB_v2_3_2', JSON.stringify(db)); renderAll(); }
function exportData() {
    const dataStr = JSON.stringify(db, null, 2);
    const dataBlob = new Blob([dataStr], {type: "application/json"});
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a'); link.download = "smtv_db.json"; link.href = url; link.click();
    URL.revokeObjectURL(url);
    alert('数据已导出为 smtv_db.json 文件！');
}
function importData(event) {
    const file = event.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importedDb = JSON.parse(e.target.result);
            if (importedDb.demons && importedDb.fusions && importedDb.nextDemonId) {
                if (confirm('确定要用导入的数据覆盖现有数据吗？此操作不可撤销。')) {
                    importedDb.demons.forEach(d => { if(d.level === undefined) d.level = 0; });
                    db = importedDb;
                    saveData();
                    alert('数据导入成功！');
                }
            } else { alert('文件格式不正确！'); }
        } catch (error) { alert('导入失败！无效的JSON文件。'); console.error(error); }
    };
    reader.readAsText(file);
    event.target.value = null;
}
function processDemonForm(){ if (editState.type === 'demon') saveDemonChanges(); else addDemon(); }
function addDemon() {
    const name = document.getElementById('demon-name').value.trim(); const level = parseInt(document.getElementById('demon-level').value, 10); const price = parseInt(document.getElementById('demon-price').value, 10);
    if (!name || isNaN(level) || level <=0 || isNaN(price) || price < 0) return alert('请输入有效的仲魔名称、等级和价格！');
    if (db.demons.some(d => d.name === name)) return alert('该仲魔已存在！');
    db.demons.push({ id: db.nextDemonId++, name, level, price });
    document.getElementById('demon-name').value = ''; document.getElementById('demon-level').value = ''; document.getElementById('demon-price').value = '';
    saveData();
}
function deleteDemon(demonId) {
    if (!confirm('确定要删除这个仲魔吗？所有与它相关的合成公式也会被删除。')) return;
    db.demons = db.demons.filter(d => d.id !== demonId);
    db.fusions = db.fusions.filter(f => f.resultId !== demonId && f.sourceA_Id !== demonId && f.sourceB_Id !== demonId);
    if(editState.type === 'demon' && editState.targetId === demonId) cancelEditMode();
    saveData();
}
function processFusionForm(){ if (editState.type === 'fusion') saveFusionChanges(); else addFusion(); }
function addFusion() {
    const ids = ['source-a-select', 'source-b-select', 'result-select'].map(s => parseInt(document.getElementById(s).value, 10));
    if (ids.some(id => !id)) return alert('请选择全部三个仲魔。'); if (new Set(ids).size !== 3) return alert('素材和结果不能是同一个仲魔。');
    const [sourceA_Id, sourceB_Id, resultId] = ids; const sortedSources = [sourceA_Id, sourceB_Id].sort((a, b) => a - b);
    if (db.fusions.some(f => f.resultId === resultId && f.sourceA_Id === sortedSources[0] && f.sourceB_Id === sortedSources[1])) return alert('这个合成公式已经存在了。');
    db.fusions.push({ resultId, sourceA_Id: sortedSources[0], sourceB_Id: sortedSources[1] });
    saveData();
}
function deleteFusion(index) {
    if (!confirm('确定要删除这个合成公式吗？')) return;
    db.fusions.splice(index, 1);
    if(editState.type === 'fusion' && editState.targetId === index) cancelEditMode();
    saveData();
}
function startEditDemon(demonId) {
    cancelEditMode(); const demon = getDemonById(demonId); if (!demon) return;
    editState = { type: 'demon', targetId: demonId };
    document.getElementById('demon-form-title').scrollIntoView({ behavior: 'smooth' });
    document.getElementById('demon-name').value = demon.name; document.getElementById('demon-level').value = demon.level; document.getElementById('demon-price').value = demon.price;
    const submitBtn = document.getElementById('demon-submit-btn'); submitBtn.textContent = '保存修改'; submitBtn.className = 'btn-edit-action';
    document.getElementById('cancel-edit-btn').style.display = 'block';
}
function saveDemonChanges() {
    const demon = getDemonById(editState.targetId); if (!demon) return;
    const name = document.getElementById('demon-name').value.trim(); const level = parseInt(document.getElementById('demon-level').value, 10); const price = parseInt(document.getElementById('demon-price').value, 10);
    if (!name || isNaN(level) || level <=0 || isNaN(price) || price < 0) return alert('请输入有效的仲魔名称、等级和价格！');
    if (db.demons.some(d => d.name === name && d.id !== demon.id)) return alert('该仲魔名称与其他仲魔重复！');
    demon.name = name; demon.level = level; demon.price = price;
    cancelEditMode(); saveData();
}
function startEditFusion(fusionIndex) {
    cancelEditMode(); const fusion = db.fusions[fusionIndex]; if (!fusion) return;
    editState = { type: 'fusion', targetId: fusionIndex };
    document.getElementById('fusion-form-title').scrollIntoView({ behavior: 'smooth' });
    document.getElementById('source-a-select').value = fusion.sourceA_Id; document.getElementById('source-b-select').value = fusion.sourceB_Id; document.getElementById('result-select').value = fusion.resultId;
    const submitBtn = document.getElementById('fusion-submit-btn'); submitBtn.textContent = '保存修改'; submitBtn.className = 'btn-edit-action';
    document.getElementById('cancel-edit-btn').style.display = 'block';
}
function saveFusionChanges() {
    const fusion = db.fusions[editState.targetId]; if (!fusion) return;
    const ids = ['source-a-select', 'source-b-select', 'result-select'].map(s => parseInt(document.getElementById(s).value, 10));
    if (ids.some(id => !id)) return alert('请选择全部三个仲魔。'); if (new Set(ids).size !== 3) return alert('素材和结果不能是同一个仲魔。');
    const [sourceA_Id, sourceB_Id, resultId] = ids; const sortedSources = [sourceA_Id, sourceB_Id].sort((a, b) => a - b);
    if (db.fusions.some((f, i) => i !== editState.targetId && f.resultId === resultId && f.sourceA_Id === sortedSources[0] && f.sourceB_Id === sortedSources[1])) return alert('修改后的合成公式与其他公式重复！');
    fusion.resultId = resultId; fusion.sourceA_Id = sortedSources[0]; fusion.sourceB_Id = sortedSources[1];
    cancelEditMode(); saveData();
}
function cancelEditMode() {
    editState = { type: 'none', targetId: null };
    document.getElementById('demon-name').value = ''; document.getElementById('demon-level').value = ''; document.getElementById('demon-price').value = '';
    let btn = document.getElementById('demon-submit-btn'); btn.textContent = '添加仲魔'; btn.className = 'btn-add';
    btn = document.getElementById('fusion-submit-btn'); btn.textContent = '添加合成公式'; btn.className = 'btn-add';
    document.getElementById('cancel-edit-btn').style.display = 'none';
}

function renderAll() {
    const sortedDemons = [...db.demons].sort((a, b) => { if (a.level !== b.level) return a.level - b.level; return a.name.localeCompare(b.name, 'zh-CN'); });
    renderManagementLists(sortedDemons); renderCalculatorSelects(sortedDemons); updateCalculatorResults();
}
function renderManagementLists(sortedDemons) {
    document.getElementById('demon-list').innerHTML = '<ul>' + db.demons.sort((a,b) => a.level - b.level).map(d => `<li><span>Lv${d.level} <strong>${d.name}</strong> - ${d.price.toLocaleString()} Macca</span><div style="display:flex; gap: 5px;"><button class="btn-edit" onclick="startEditDemon(${d.id})">修改</button><button class="btn-delete" onclick="deleteDemon(${d.id})">删除</button></div></li>`).join('') + '</ul>';
    const demonOptions = sortedDemons.map(d => `<option value="${d.id}">Lv${d.level} - ${d.name}</option>`).join('');
    ['source-a-select', 'source-b-select', 'result-select'].forEach(id => document.getElementById(id).innerHTML = demonOptions);
    document.getElementById('fusion-list').innerHTML = '<ul>' + db.fusions.map((f, i) => {
        const sA = getDemonById(f.sourceA_Id), sB = getDemonById(f.sourceB_Id), res = getDemonById(f.resultId);
        return (sA && sB && res) ? `<li><span>${sA.name} + ${sB.name} = <strong>${res.name}</strong></span><div style="display:flex; gap: 5px;"><button class="btn-edit" onclick="startEditFusion(${i})">修改</button><button class="btn-delete" onclick="deleteFusion(${i})">删除</button></div></li>` : '';
    }).join('') + '</ul>';
}
function renderCalculatorSelects(sortedDemons) {
    const placeholder = '<option value="">-- 任意 --</option>'; const demonOptions = sortedDemons.map(d => `<option value="${d.id}">Lv${d.level} - ${d.name}</option>`).join('');
    ['slot1', 'slot2', 'slot3'].forEach(id => {
        const select = document.getElementById(id); const currentValue = select.value;
        select.innerHTML = placeholder + demonOptions; select.value = currentValue;
    });
}
let calculatorState = { slot1: null, slot2: null, slot3: null };
function updateCalculatorState() {
    calculatorState = { slot1: parseInt(document.getElementById('slot1').value) || null, slot2: parseInt(document.getElementById('slot2').value) || null, slot3: parseInt(document.getElementById('slot3').value) || null, };
    updateCalculatorResults();
}
function resetCalculator() { ['slot1', 'slot2', 'slot3'].forEach(id => document.getElementById(id).value = ""); updateCalculatorState(); }

// --- CALCULATOR V2.3.2 LOGIC (BUGFIXED) ---
function getCheapestCost(demonId, ancestry) { // NO default for ancestry
    const demon = getDemonById(demonId);
    if (!demon) return Infinity; 
    if (ancestry.has(demonId)) return demon.price;
    if (ancestry.size === 0 && costCache[demonId] !== undefined) return costCache[demonId];
    let minCost = demon.price;
    const fusionPaths = db.fusions.filter(f => f.resultId === demonId);
    const newAncestry = new Set(ancestry).add(demonId);
    for (const path of fusionPaths) {
        const costA = getCheapestCost(path.sourceA_Id, newAncestry);
        const costB = getCheapestCost(path.sourceB_Id, newAncestry);
        minCost = Math.min(minCost, costA + costB);
    }
    if (ancestry.size === 0) costCache[demonId] = minCost;
    return minCost;
}
function updateCalculatorResults() {
    costCache = {}; 
    const { slot1, slot2, slot3 } = calculatorState;
    let recipes = [];
    let filteredFusions = db.fusions.filter(f => {
        const sA = f.sourceA_Id, sB = f.sourceB_Id, res = f.resultId;
        const s1_match = !slot1 || slot1 === sA || slot1 === sB;
        const s2_match = !slot2 || slot2 === sA || slot2 === sB;
        const s3_match = !slot3 || slot3 === res;
        if (slot1 && slot2 && slot1 === slot2) return false;
        return s1_match && s2_match && s3_match;
    });
    const initialAncestry = new Set();
    for(const f of filteredFusions) {
        const costA = getCheapestCost(f.sourceA_Id, initialAncestry);
        const costB = getCheapestCost(f.sourceB_Id, initialAncestry);
        recipes.push({ type: 'fusion', ...f, trueCost: costA + costB, costA: costA, costB: costB });
    }
    if (slot3 && !slot1 && !slot2) {
        const target = getDemonById(slot3);
        if (target) recipes.push({ type: 'direct', demonId: slot3, trueCost: getCheapestCost(slot3, initialAncestry) });
    }
    renderResults(recipes, document.getElementById('results-container'), initialAncestry);
}
function renderResults(recipes, container, ancestry) {
    container.innerHTML = "";
    recipes.sort((a, b) => a.trueCost - b.trueCost);
    const resultList = document.createElement('ul'); resultList.className = 'result-list';
    recipes.forEach(recipe => {
        if (recipe.type === 'fusion') {
            const sA = getDemonById(recipe.sourceA_Id), sB = getDemonById(recipe.sourceB_Id), res = getDemonById(recipe.resultId);
            if (sA && sB && res) resultList.appendChild(createFusionElement(sA, sB, res, ancestry, recipe.costA, recipe.costB));
        } else if (recipe.type === 'direct') {
            const demon = getDemonById(recipe.demonId);
            if (demon) resultList.appendChild(createDirectPurchaseElement(demon, ancestry));
        }
    });
    container.appendChild(resultList);
}

// **BUGFIX in V2.3.2**: Harmonized all `ancestry` usage to be Sets
function createDemonSpan(demon, ancestry) {
    const span = document.createElement('span'); span.textContent = `Lv${demon.level} ${demon.name}`;
    if (ancestry.has(demon.id)) {
        span.className = 'demon-no-link'; span.title = '为防止无限循环，已禁止展开';
    } else {
        span.className = 'demon-link'; span.onclick = (e) => { e.stopPropagation(); toggleSubList(e.currentTarget, demon, ancestry); };
    }
    return span;
}
function toggleSubList(element, demon, ancestry) {
    const parentItem = element.closest('.result-item');
    let subListContainer = parentItem.querySelector('.sub-list-container');
    if (subListContainer) { subListContainer.remove(); return; }
    subListContainer = document.createElement('div'); subListContainer.className = 'sub-list-container';
    parentItem.appendChild(subListContainer);
    
    // **FIX in V2.3.2**: Correctly create the new Set-based ancestry
    const parentIds = getDemonIdsFromElement(parentItem);
    const newAncestry = new Set([...ancestry, ...parentIds]);
    
    const recipes = [
        ...db.fusions.filter(f => f.resultId === demon.id).map(f => {
            const costA = getCheapestCost(f.sourceA_Id, newAncestry); const costB = getCheapestCost(f.sourceB_Id, newAncestry);
            return { type: 'fusion', ...f, trueCost: costA + costB, costA: costA, costB: costB };
        }),
        { type: 'direct', demonId: demon.id, trueCost: getDemonById(demon.id).price }
    ];
    renderResults(recipes, subListContainer, newAncestry);
}
function createFusionElement(sA, sB, res, ancestry, costA, costB) {
    const li = document.createElement('li'); li.className = 'result-item';
    li.dataset.sA = sA.id; li.dataset.sB = sB.id; li.dataset.res = res.id;
    const path = document.createElement('div'); path.className = 'result-path';
    path.append( createDemonSpan(sA, ancestry), ' + ', createDemonSpan(sB, ancestry), ' = ', createDemonSpan(res, ancestry) );
    const cost = document.createElement('div'); cost.className = 'result-cost';
    cost.innerHTML = `${(costA + costB).toLocaleString()} M <span class="breakdown">(最优成本: ${costA.toLocaleString()} + ${costB.toLocaleString()})</span>`;
    path.appendChild(cost); li.appendChild(path);
    return li;
}
function createDirectPurchaseElement(demon, ancestry) {
    const li = document.createElement('li'); li.className = 'result-item direct-purchase';
    li.dataset.res = demon.id;
    const path = document.createElement('div'); path.className = 'result-path';
    path.append('从全书召唤 ', createDemonSpan(demon, ancestry));
    const cost = document.createElement('div'); cost.className = 'result-cost';
    cost.innerHTML = `${demon.price.toLocaleString()} M <span class="breakdown">(直接购买)</span>`;
    path.appendChild(cost); li.appendChild(path);
    return li;
}
function getDemonById(id) { return db.demons.find(d => d.id === id); }
function getDemonIdsFromElement(element) {
    const ids = [];
    if(element.dataset.sA) ids.push(parseInt(element.dataset.sA));
    if(element.dataset.sB) ids.push(parseInt(element.dataset.sB));
    if(element.dataset.res) ids.push(parseInt(element.dataset.res));
    return ids.filter(id => !isNaN(id));
}
function showTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    document.getElementById(tabName).classList.add('active');
    document.querySelector(`.tab-button[onclick="showTab('${tabName}')"]`).classList.add('active');
}
window.onload = () => {
    initializeDefaultData(); loadData(); renderAll(); cancelEditMode(); showTab('calculator');
    document.getElementById('import-file').addEventListener('change', importData);
    ['slot1', 'slot2', 'slot3'].forEach(id => document.getElementById(id).addEventListener('change', updateCalculatorState));
};

</script>
</body>
</html>
