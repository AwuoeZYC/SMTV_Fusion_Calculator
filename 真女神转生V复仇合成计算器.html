<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMTV 复仇 - 最优价格合成器</title>
    <style>
        :root {
            --bg-color: #1a1a2e;
            --primary-color: #16213e;
            --secondary-color: #0f3460;
            --accent-color: #e94560;
            --text-color: #dcdcdc;
            --border-color: #535353;
            --success-color: #4CAF50;
            --danger-color: #f44336;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 15px;
            font-size: 16px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--primary-color);
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid var(--secondary-color);
            margin-bottom: 20px;
        }

        .tab-button {
            padding: 10px 20px;
            cursor: pointer;
            background-color: transparent;
            border: none;
            color: var(--text-color);
            font-size: 1.1em;
            opacity: 0.7;
            transition: opacity 0.3s, border-bottom 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab-button.active {
            opacity: 1;
            border-bottom: 3px solid var(--accent-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        h1, h2, h3 {
            color: var(--accent-color);
            border-bottom: 1px solid var(--secondary-color);
            padding-bottom: 10px;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }

        input[type="text"], input[type="number"], select {
            width: 100%;
            padding: 12px;
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 1em;
        }

        button {
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .btn-add {
            background-color: var(--success-color);
            color: white;
            width: 100%;
        }
        .btn-add:hover {
            background-color: #45a049;
        }
        
        .btn-delete {
            background-color: var(--danger-color);
            color: white;
            padding: 5px 10px;
            font-size: 0.8em;
            margin-left: 10px;
        }
        .btn-delete:hover {
             background-color: #da190b;
        }

        .data-list ul {
            list-style: none;
            padding: 0;
        }

        .data-list li {
            background-color: var(--secondary-color);
            padding: 10px 15px;
            margin-bottom: 8px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        #calculator-result {
            margin-top: 20px;
        }
        
        .result-item {
            background-color: var(--secondary-color);
            border-left: 5px solid var(--success-color);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 0 5px 5px 0;
        }
        
        .result-item.direct-purchase {
            border-left-color: var(--accent-color);
        }

        .result-item .cost {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--accent-color);
        }
        
        .result-item .path {
            font-size: 1.1em;
            margin-top: 10px;
        }
        
        .result-item .breakdown {
            font-size: 0.9em;
            opacity: 0.8;
            margin-top: 8px;
        }
        
        hr {
            border: 1px solid var(--secondary-color);
            margin: 25px 0;
        }

    </style>
</head>
<body>

    <div class="container">
        <h1>SMTV:R 最优价格合成器</h1>

        <div class="tabs">
            <button class="tab-button active" onclick="showTab('calculator')">最优价格计算器</button>
            <button class="tab-button" onclick="showTab('management')">数据管理</button>
        </div>

        <div id="calculator" class="tab-content active">
            <h2>计算器</h2>
            <div class="form-group">
                <label for="target-demon-select">选择目标仲魔：</label>
                <select id="target-demon-select">
                    <option value="">-- 请选择 --</option>
                </select>
            </div>
            <div id="calculator-result">
                </div>
        </div>

        <div id="management" class="tab-content">
            <h2>仲魔管理</h2>
            <div class="form-group">
                <label for="demon-name">仲魔名称：</label>
                <input type="text" id="demon-name" placeholder="例如: 皮克希">
            </div>
            <div class="form-group">
                <label for="demon-price">全书价格 (Macca)：</label>
                <input type="number" id="demon-price" placeholder="例如: 840">
            </div>
            <button class="btn-add" onclick="addDemon()">添加仲魔</button>

            <hr>
            <h3>已录入的仲魔</h3>
            <div class="data-list" id="demon-list"></div>

            <hr>
            <h2>合成公式管理</h2>
            <div class="form-group">
                <label for="source-a-select">素材 1：</label>
                <select id="source-a-select"></select>
            </div>
            <div class="form-group">
                <label for="source-b-select">素材 2：</label>
                <select id="source-b-select"></select>
            </div>
            <div class="form-group">
                <label for="result-select">结果：</label>
                <select id="result-select"></select>
            </div>
            <button class="btn-add" onclick="addFusion()">添加合成公式</button>
            
            <hr>
            <h3>已录入的公式</h3>
            <div class="data-list" id="fusion-list"></div>
        </div>
    </div>

    <script>
        // --- DATA INITIALIZATION & STORAGE ---

        let db = {
            demons: [], // { id, name, price }
            fusions: [], // { resultId, sourceA_Id, sourceB_Id }
            nextDemonId: 1
        };

        // Pre-populate with example data if the database is empty
        function initializeDefaultData() {
            const defaultDemons = [
                { id: 1, name: "皮克希", price: 560 },
                { id: 2, name: "飞天", price: 1820 },
                { id: 3, name: "天使", price: 2100 },
                { id: 4, name: "美人鱼", price: 2940 },
                { id: 5, name: "天钿女命", price: 3270 },
            ];
            const defaultFusions = [
                // 示例: 皮克希 + 飞天 = 天使
                { resultId: 3, sourceA_Id: 1, sourceB_Id: 2 }
            ];
            
            // Check if data already exists in localStorage
            const storedDb = localStorage.getItem('smtvFusionDB');
            if (!storedDb) {
                db.demons = defaultDemons;
                db.fusions = defaultFusions;
                db.nextDemonId = 6;
                saveData();
            }
        }
        
        function loadData() {
            const storedDb = localStorage.getItem('smtvFusionDB');
            if (storedDb) {
                db = JSON.parse(storedDb);
            }
        }

        function saveData() {
            localStorage.setItem('smtvFusionDB', JSON.stringify(db));
        }

        // --- DATA MANAGEMENT FUNCTIONS ---

        function addDemon() {
            const nameInput = document.getElementById('demon-name');
            const priceInput = document.getElementById('demon-price');
            const name = nameInput.value.trim();
            const price = parseInt(priceInput.value, 10);

            if (!name || isNaN(price) || price <= 0) {
                alert('请输入有效的仲魔名称和价格！');
                return;
            }
            
            if (db.demons.some(d => d.name === name)) {
                alert('该仲魔已存在！');
                return;
            }

            db.demons.push({ id: db.nextDemonId, name: name, price: price });
            db.nextDemonId++;
            
            saveData();
            nameInput.value = '';
            priceInput.value = '';
            renderManagementLists();
            alert(`仲魔 "${name}" 添加成功！`);
        }
        
        function deleteDemon(demonId) {
            if (!confirm(`确定要删除这个仲魔吗？所有与它相关的合成公式也会被删除。`)) {
                return;
            }
            db.demons = db.demons.filter(d => d.id !== demonId);
            db.fusions = db.fusions.filter(f => f.resultId !== demonId && f.sourceA_Id !== demonId && f.sourceB_Id !== demonId);
            saveData();
            renderManagementLists();
        }

        function addFusion() {
            const sourceA_Id = parseInt(document.getElementById('source-a-select').value, 10);
            const sourceB_Id = parseInt(document.getElementById('source-b-select').value, 10);
            const resultId = parseInt(document.getElementById('result-select').value, 10);

            if (!sourceA_Id || !sourceB_Id || !resultId) {
                alert('请选择全部三个仲魔。');
                return;
            }
            
            if (sourceA_Id === sourceB_Id || sourceA_Id === resultId || sourceB_Id === resultId) {
                alert('素材和结果不能是同一个仲魔。');
                return;
            }

            // To avoid duplicates like A+B=C and B+A=C, we sort the source IDs
            const sortedSources = [sourceA_Id, sourceB_Id].sort((a, b) => a - b);

            if (db.fusions.some(f => f.resultId === resultId && f.sourceA_Id === sortedSources[0] && f.sourceB_Id === sortedSources[1])) {
                alert('这个合成公式已经存在了。');
                return;
            }

            db.fusions.push({ resultId: resultId, sourceA_Id: sortedSources[0], sourceB_Id: sortedSources[1] });
            saveData();
            renderManagementLists();
            alert('合成公式添加成功！');
        }
        
        function deleteFusion(index) {
            if (!confirm(`确定要删除这个合成公式吗？`)) {
                return;
            }
            db.fusions.splice(index, 1);
            saveData();
            renderManagementLists();
        }

        // --- UI RENDERING FUNCTIONS ---
        
        function renderManagementLists() {
            // Sort demons by name for dropdowns
            const sortedDemons = [...db.demons].sort((a, b) => a.name.localeCompare(b.name, 'zh-CN'));

            // Render Demon List
            const demonList = document.getElementById('demon-list');
            demonList.innerHTML = '<ul>' + db.demons.map(d => 
                `<li>
                    <span><strong>${d.name}</strong> - ${d.price} Macca</span>
                    <button class="btn-delete" onclick="deleteDemon(${d.id})">删除</button>
                </li>`
            ).join('') + '</ul>';

            // Render Fusion List
            const fusionList = document.getElementById('fusion-list');
            fusionList.innerHTML = '<ul>' + db.fusions.map((f, index) => {
                const sourceA = getDemonById(f.sourceA_Id);
                const sourceB = getDemonById(f.sourceB_Id);
                const result = getDemonById(f.resultId);
                if (!sourceA || !sourceB || !result) return ''; // Skip if a demon was deleted
                return `<li>
                    <span>${sourceA.name} + ${sourceB.name} = <strong>${result.name}</strong></span>
                    <button class="btn-delete" onclick="deleteFusion(${index})">删除</button>
                </li>`;
            }).join('') + '</ul>';

            // Populate all select dropdowns
            const demonOptions = sortedDemons.map(d => `<option value="${d.id}">${d.name}</option>`).join('');
            document.getElementById('source-a-select').innerHTML = demonOptions;
            document.getElementById('source-b-select').innerHTML = demonOptions;
            document.getElementById('result-select').innerHTML = demonOptions;
            document.getElementById('target-demon-select').innerHTML = '<option value="">-- 请选择 --</option>' + demonOptions;
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`.tab-button[onclick="showTab('${tabName}')"]`).classList.add('active');
        }

        // --- CALCULATOR LOGIC ---

        function getDemonById(id) {
            return db.demons.find(d => d.id === id);
        }

        function calculateCheapestPath() {
            const targetDemonId = parseInt(document.getElementById('target-demon-select').value, 10);
            const resultDiv = document.getElementById('calculator-result');
            resultDiv.innerHTML = '';

            if (!targetDemonId) return;

            const targetDemon = getDemonById(targetDemonId);
            let acquisitionMethods = [];

            // 1. Direct purchase
            acquisitionMethods.push({
                type: 'direct',
                cost: targetDemon.price,
                path: `${targetDemon.name}`,
                breakdown: `从恶魔全书直接召唤`
            });

            // 2. Fusions
            const possibleFusions = db.fusions.filter(f => f.resultId === targetDemonId);
            
            for (const fusion of possibleFusions) {
                const sourceA = getDemonById(fusion.sourceA_Id);
                const sourceB = getDemonById(fusion.sourceB_Id);
                
                if (sourceA && sourceB) {
                    const fusionCost = sourceA.price + sourceB.price;
                    acquisitionMethods.push({
                        type: 'fusion',
                        cost: fusionCost,
                        path: `${sourceA.name} + ${sourceB.name}`,
                        breakdown: `(素材成本: ${sourceA.price} + ${sourceB.price})`
                    });
                }
            }
            
            // 3. Sort by cost (cheapest first)
            acquisitionMethods.sort((a, b) => a.cost - b.cost);
            
            // 4. Display results
            let rank = 1;
            for (const method of acquisitionMethods) {
                 const itemDiv = document.createElement('div');
                 itemDiv.classList.add('result-item');
                 if(method.type === 'direct') {
                     itemDiv.classList.add('direct-purchase');
                 }
                 
                 itemDiv.innerHTML = `
                    <h3>${rank}. ${method.path}</h3>
                    <div class="cost">${method.cost.toLocaleString()} Macca</div>
                    <div class="breakdown">${method.breakdown}</div>
                 `;
                 resultDiv.appendChild(itemDiv);
                 rank++;
            }
        }

        // --- EVENT LISTENERS ---

        document.getElementById('target-demon-select').addEventListener('change', calculateCheapestPath);
        
        // --- INITIAL LOAD ---
        
        window.onload = () => {
            initializeDefaultData(); // Sets up default data only if nothing is stored
            loadData();
            renderManagementLists();
            showTab('calculator');
        };

    </script>
</body>
</html>